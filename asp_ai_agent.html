<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP AI Agent - Antibiotic Stewardship Training</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .model-selector {
            background-color: rgba(255,255,255,0.1);
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .model-selector label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .model-selector select {
            background-color: white;
            color: #333;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        main {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section {
            margin-bottom: 2rem;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .feature-card {
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .feature-card h3 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .chat-interface {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background-color: #fafafa;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .chat-input-area {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .chat-submit {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .chat-submit:hover {
            background-color: #2980b9;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
        }
        
        .user-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        
        .ai-message {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>ASP AI Training Assistant</h1>
                    <p class="subtitle">AI-Powered Antibiotic Stewardship Education for ID Fellows</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="model-selector">
                        <label for="ai-model">AI Model:</label>
                        <select id="ai-model">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <a href="/dashboard" style="padding: 0.5rem 1rem; background-color: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        ‚Üê Back to Dashboard
                    </a>
                    <a href="/logout" style="padding: 0.5rem 1rem; background-color: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 4px; font-size: 0.875rem;">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <main>
            <section class="section">
                <h2>Welcome to the ASP Training Platform</h2>
                <p>This interactive platform uses AI to help Infectious Disease fellows develop expertise in antibiotic stewardship through case-based learning, evidence-based discussions, and personalized feedback.</p>
            </section>
            
            <section class="section">
                <h2>Key Features</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>Case-Based Learning</h3>
                        <p>Work through realistic clinical scenarios with AI guidance to develop practical stewardship skills.</p>
                    </div>
                    <div class="feature-card">
                        <h3>Evidence-Based Discussions</h3>
                        <p>Explore current literature and guidelines with AI assistance to support clinical decision-making.</p>
                    </div>
                    <div class="feature-card">
                        <h3>Personalized Feedback</h3>
                        <p>Receive tailored suggestions and insights based on your responses and learning progress.</p>
                    </div>
                    <div class="feature-card">
                        <h3>Interactive Scenarios</h3>
                        <p>Practice handling common stewardship challenges in a safe, educational environment.</p>
                    </div>
                </div>
            </section>
            
            <section class="section">
                <h2>AI Assistant</h2>
                <div class="chat-interface">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            Hello! I'm your ASP training assistant. I can help you work through antibiotic stewardship cases, discuss guidelines, or answer questions about antimicrobial therapy. How can I assist you today?
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question or describe a case...">
                        <button class="chat-submit" id="chatSubmit">Send</button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        // API Configuration
        // Check if we're running on our own server (local or asp-ai-agent.com)
        const isLocal = window.location.hostname === 'localhost' ||
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname.startsWith('192.168.') ||
                       window.location.hostname.startsWith('10.') ||
                       window.location.hostname.includes('asp-ai-agent.com') ||
                       window.location.protocol === 'file:';

        // Use current host with correct protocol
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port || (protocol === 'https:' ? '443' : '80');
        const currentHost = `${protocol}//${hostname}${port ? ':' + port : ''}`;

        // Initialize markdown converter
        const markdownConverter = new showdown.Converter({ tables: true });

        // Model management
        let currentModel = null;
        let availableModels = [];

        // Load available models from API
        async function loadModels() {
            try {
                const response = await fetch(`${currentHost}/api/models`);
                const data = await response.json();
                availableModels = data.models;

                const modelSelect = document.getElementById('ai-model');
                modelSelect.innerHTML = '';

                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                // Set default model - prefer Claude Sonnet 4.5
                if (data.models.length > 0) {
                    const claudeSonnet = data.models.find(m =>
                        m.id.includes('claude') && m.id.includes('sonnet')
                    );
                    const defaultModel = claudeSonnet || data.models[0];
                    currentModel = defaultModel.id;
                    modelSelect.value = currentModel;
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                document.getElementById('ai-model').innerHTML = '<option value="">Failed to load models</option>';
            }
        }

        // Update model when selection changes
        document.getElementById('ai-model').addEventListener('change', (e) => {
            currentModel = e.target.value;
            const model = availableModels.find(m => m.id === currentModel);
            console.log(`Switched to ${model?.name || currentModel}`);
        });

        // Load models on page load
        loadModels();
        
        // Basic chat interface functionality
        const chatInput = document.getElementById('chatInput');
        const chatSubmit = document.getElementById('chatSubmit');
        const chatMessages = document.getElementById('chatMessages');

        let conversationHistory = [];

        chatSubmit.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Check if model is selected
            if (!currentModel) {
                addMessage('Please wait for models to load, then select a model.', 'ai');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            // Clear input and show loading
            chatInput.value = '';
            chatSubmit.disabled = true;
            chatSubmit.textContent = 'Sending...';

            try {
                const response = await callAI(message);
                addMessage(response, 'ai');
                conversationHistory.push({ role: 'assistant', content: response });
            } catch (error) {
                console.error('Error calling AI:', error);
                addMessage(`Sorry, I encountered an error: ${error.message}`, 'ai');
            } finally {
                chatSubmit.disabled = false;
                chatSubmit.textContent = 'Send';
            }
        }
        
        async function callAI(userMessage) {
            console.log('callAI called with model:', currentModel);

            const systemPrompt = `You are an expert AI assistant specializing in Antimicrobial Stewardship Programs (ASP) for Infectious Disease fellows.

Your role is to:
1. Provide evidence-based guidance on antibiotic stewardship practices
2. Help analyze clinical cases and recommend appropriate antimicrobial therapy
3. Discuss ASP implementation strategies and quality metrics
4. Support learning objectives for ID fellowship training
5. Reference current guidelines (IDSA, SHEA, CDC) when appropriate

Maintain a professional, educational tone while being practical and actionable in your responses.`;

            // Use unified /api/chat endpoint
            const messages = [
                { role: 'system', content: systemPrompt },
                ...conversationHistory.slice(-10) // Keep last 10 messages for context
            ];

            const payload = {
                model: currentModel,
                messages: messages
            };

            console.log('Sending request to:', `${currentHost}/api/chat`);
            console.log('Payload:', payload);

            const response = await fetch(`${currentHost}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API error response:', errorText);
                throw new Error(`API error: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('API result:', result);
            return result.response || result.text || 'No response received';
        }
        
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            // Render markdown as HTML for AI responses
            if (sender === 'ai') {
                messageDiv.innerHTML = markdownConverter.makeHtml(text);
            } else {
                messageDiv.textContent = text;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
</body>
</html>