Resources:
  # Create EFS file system for persistent storage
  FileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: asp-ai-agent-storage

  # Mount targets for each subnet (Beanstalk creates these automatically)
  MountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref FileSystem
      SubnetId: !Select [0, !GetAtt Environment.Subnets]
      SecurityGroups:
        - !Ref MountTargetSecurityGroup

  MountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref FileSystem
      SubnetId: !Select [1, !GetAtt Environment.Subnets]
      SecurityGroups:
        - !Ref MountTargetSecurityGroup

  # Security group for EFS mount targets
  MountTargetSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for EFS mount targets
      VpcId: !GetAtt Environment.VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !GetAtt Environment.InstanceSecurityGroup

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_mount_efs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Mount EFS for persistent storage

      EFS_ID=$(/opt/aws/bin/ec2-metadata --instance-id | cut -d " " -f 2 | xargs -I {} aws ec2 describe-tags --filters "Name=resource-id,Values={}" "Name=key,Values=elasticbeanstalk:environment-id" --region us-east-1 --query 'Tags[0].Value' --output text | xargs -I {} aws elasticbeanstalk describe-environment-resources --environment-id {} --region us-east-1 --query 'EnvironmentResources.Instances[0].Id' --output text)

      # Create mount point
      mkdir -p /mnt/efs

      # Mount EFS
      mount -t efs -o tls ${EFS_ID}:/ /mnt/efs

      # Create data directory
      mkdir -p /mnt/efs/data
      chmod 777 /mnt/efs/data

      # Create symlink for app
      ln -sf /mnt/efs/data /var/app/current/data
