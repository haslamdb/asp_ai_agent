<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP Leadership Lab</title>

    <!-- CSRF Protection -->
    <meta name="csrf-token" id="csrf-token">
    <script src="/csrf_helper.js"></script>
    <script>
        // Fetch and set CSRF token on page load
        (async function() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                document.getElementById('csrf-token').setAttribute('content', data.csrf_token);
                console.log('CSRF token loaded');
            } catch (error) {
                console.error('Failed to load CSRF token:', error);
            }
        })();
    </script>

    <!-- Load Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Load Showdown Markdown-to-HTML converter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        /* Use the Inter font, a clean sans-serif */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for prose */
        .prose h3 {
            margin-bottom: 0.5em;
            margin-top: 1.25em;
        }
        .prose ul {
            margin-top: 0.5em;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-700 to-purple-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ASP Leadership Lab</h1>
                    <p class="mt-1 text-lg opacity-90">Advanced Competency Modules for ID Fellows</p>
                </div>
                <div class="flex gap-3">
                    <a href="/dashboard" class="text-sm px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-md transition">
                        ← Back to Dashboard
                    </a>
                    <a href="/logout" class="text-sm px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-md transition">
                        Logout
                    </a>
                </div>
                <!-- AI Model Selector -->
                <div class="bg-white/10 rounded-lg p-3">
                    <label for="ai-model-select" class="block text-sm font-medium mb-2">AI Model:</label>
                    <select id="ai-model-select" class="bg-white text-gray-900 rounded px-3 py-1 text-sm">
                        <option value="">Loading models...</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        
        <!-- Module 1: Leadership & Program Management -->
        <section id="module-1" class="bg-white p-6 sm:p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-900 mb-1">Module 1: Leadership & Program Management</h2>
            <p class="text-gray-600 mb-4">Develop a compelling business case for an ASP initiative.</p>
            
            <div class="prose prose-indigo max-w-none text-gray-700 space-y-4 mb-6">
                <p class="font-medium">Your Task:</p>
                <p class="bg-indigo-50 p-4 rounded-md border border-indigo-200">
                    "Your hospital's surgical unit has persistently high rates of <em>C. difficile</em> infection and broad-spectrum antibiotic use. Draft a 1-page business case for a new 'surgical stewardship' initiative to present to hospital administration."
                </p>
            </div>

            <div>
                <label for="business-case" class="block text-sm font-medium text-gray-700">Your Business Case Draft:</label>
                <textarea id="business-case" rows="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Draft your business case here..."></textarea>
            </div>
            <button id="submit-business-case" class="mt-4 inline-flex w-full justify-center items-center rounded-md border border-transparent bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                ✨ Submit for Administrator Feedback
            </button>

            <!-- Feedback Area for Module 1 -->
            <div id="feedback-container-1" class="mt-6 border-t pt-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Administrator's Feedback</h3>
                <div id="loading-spinner-1" class="flex flex-col items-center justify-center h-48 text-gray-600 hidden">
                    <div class="spinner"></div>
                    <p class="mt-4 text-lg font-medium">Reviewing your proposal...</p>
                </div>
                <div id="feedback-output-1" class="prose prose-indigo max-w-none text-gray-700">
                    <p class="text-gray-500">Your feedback will appear here.</p>
                </div>
                <div id="sources-container-1" class="mt-6 hidden">
                    <h4 class="text-md font-semibold text-gray-900">Feedback informed by:</h4>
                    <ul id="sources-list-1" class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- Module 2: Behavioral Science & Communication -->
        <section id="module-2" class="bg-white p-6 sm:p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-900 mb-1">Module 2: Behavioral Science & Communication</h2>
            <p class="text-gray-600 mb-4">Understand prescriber psychology and develop effective communication strategies.</p>

            <div class="prose prose-indigo max-w-none text-gray-700 space-y-4 mb-6">
                <p class="font-medium">Your Task:</p>
                <p class="bg-indigo-50 p-4 rounded-md border border-indigo-200">
                    Select a prescriber archetype to analyze. The AI will generate a profile, identify their likely cognitive biases, and suggest evidence-based communication strategies from ASP literature.
                </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="prescriber-role" class="block text-sm font-medium text-gray-700">Prescriber Role</label>
                    <select id="prescriber-role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option>Senior Surgeon</option>
                        <option>New Attending (Hospitalist)</option>
                        <option>Senior Resident (PICU)</option>
                        <option>Ambulatory Pediatrician</option>
                    </select>
                </div>
                <div>
                    <label for="prescriber-attitude" class="block text-sm font-medium text-gray-700">Primary Attitude</label>
                    <select id="prescriber-attitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option>Skeptical of ASP</option>
                        <option>Collaborative but Busy</option>
                        <option>Risk-Averse (Prefers broad-spectrum)</option>
                        <option>Open to Teaching</option>
                    </select>
                </div>
            </div>
            
            <button id="submit-profile" class="mt-4 inline-flex w-full justify-center items-center rounded-md border border-transparent bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                ✨ Generate Prescriber Profile & Strategies
            </button>

            <!-- Feedback Area for Module 2 -->
            <div id="feedback-container-2" class="mt-6 border-t pt-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Prescriber Analysis</h3>
                <div id="loading-spinner-2" class="flex flex-col items-center justify-center h-48 text-gray-600 hidden">
                    <div class="spinner"></div>
                    <p class="mt-4 text-lg font-medium">Analyzing archetype...</p>
                </div>
                <div id="feedback-output-2" class="prose prose-indigo max-w-none text-gray-700">
                    <p class="text-gray-500">Your analysis will appear here.</p>
                </div>
                <div id="sources-container-2" class="mt-6 hidden">
                    <h4 class="text-md font-semibold text-gray-900">Strategies informed by:</h4>
                    <ul id="sources-list-2" class="mt-2 list-disc list-inside space-y-1 text-sm text-gray-600">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>

                <!-- NEW: Reflection Container -->
                <div id="reflection-container-2" class="mt-6 pt-6 border-t border-gray-200 hidden">
                    <h4 class="text-md font-semibold text-gray-900">Your Reflection</h4>
                    <label for="fellow-reflection" class="block text-sm font-medium text-gray-700 mt-2">
                        Which of these communication strategies do you think would be most successful, and why? What barriers might you anticipate in this conversation?
                    </label>
                    <textarea id="fellow-reflection" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Type your reflection..."></textarea>
                    <button id="submit-reflection" class="mt-3 inline-flex items-center rounded-md border border-transparent bg-indigo-500 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Submit Reflection (Note)
                    </button>
                    <p class="mt-2 text-xs text-gray-500">(Note: This button is a placeholder for a future curriculum tracking system.)</p>
                </div>

            </div>
        </section>

    </main>

    <script>
        // === Common Elements & API Config ===
        // Check if we're running on our own server (local or asp-ai-agent.com)
        const isLocal = window.location.hostname === 'localhost' ||
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname.startsWith('192.168.') ||
                       window.location.hostname.startsWith('10.') ||
                       window.location.hostname.includes('asp-ai-agent.com') ||
                       window.location.protocol === 'file:';

        // Use current host with correct protocol
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port || (protocol === 'https:' ? '443' : '80');
        const currentHost = `${protocol}//${hostname}${port ? ':' + port : ''}`;

        // Get current selected model
        const modelSelector = document.getElementById('ai-model-select');
        let currentModel = null;
        let availableModels = [];

        // Load available models from API
        async function loadModels() {
            try {
                const response = await fetch(`${currentHost}/api/models`);
                const data = await response.json();
                availableModels = data.models;

                // Populate dropdown
                modelSelector.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    modelSelector.appendChild(option);
                });

                // Set default model - prefer Claude Opus 4.5
                if (data.models.length > 0) {
                    const claudeOpus = data.models.find(m =>
                        m.id.includes('claude') && m.id.includes('opus')
                    );
                    const defaultModel = claudeOpus || data.models[0];
                    currentModel = defaultModel.id;
                    modelSelector.value = currentModel;
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                modelSelector.innerHTML = '<option value="">Failed to load models</option>';
            }
        }

        // Update current model when selection changes
        modelSelector.addEventListener('change', (e) => {
            currentModel = e.target.value;
            const model = availableModels.find(m => m.id === currentModel);
            console.log(`Switched to ${model?.name || currentModel}`);
        });

        // Load models on page load
        loadModels();
        
        // Initialize the Markdown converter with tables enabled
        const markdownConverter = new showdown.Converter({ tables: true });

        // === Module 1: Business Case ===
        const businessCaseButton = document.getElementById('submit-business-case');
        const businessCaseInput = document.getElementById('business-case');
        const feedbackOutput1 = document.getElementById('feedback-output-1');
        const loadingSpinner1 = document.getElementById('loading-spinner-1');
        const sourcesContainer1 = document.getElementById('sources-container-1');
        const sourcesList1 = document.getElementById('sources-list-1');

        businessCaseButton.addEventListener('click', getBusinessCaseFeedback);

        const businessCaseSystemPrompt = `Act as a senior hospital administrator, like a Chief Financial Officer (CFO) or Chief Medical Officer (CMO), reviewing a business case for a new Antimicrobial Stewardship Program (ASP) initiative. Your goal is to provide tough, constructive feedback to an ID fellow.
Your critique MUST focus on the "Tier 2: Advanced Leadership & Implementation Competencies" from the national ASP curriculum. Specifically, you must check if the fellow's proposal includes:
1.  **Leadership & Program Management:** Is there a clear strategic plan? A compelling business case with an actual Return on Investment (ROI) (e.g., cost of C. diff vs. cost of the intervention)? Have they identified and planned for key stakeholders (especially resistant surgeons)?
2.  **Data Analytics & Interpretation:** Does it propose clear, measurable metrics? Does it mention calculating antimicrobial use (e.g., Days of Therapy - DOTs)? Does it plan to benchmark this data against national collaboratives (like SHARPS or PHIS)?
Be skeptical, data-driven, and practical. Your feedback should be a mix of critique and actionable advice, pushing the fellow to "Tier 2" thinking. Ground your feedback in real-world evidence from ASP literature.`;

        async function getBusinessCaseFeedback() {
            const userText = businessCaseInput.value;

            if (userText.trim().length < 20) {
                handleError('Please provide a more detailed business case draft.', feedbackOutput1);
                return;
            }

            // Show loading state
            loadingSpinner1.classList.remove('hidden');
            feedbackOutput1.innerHTML = '';
            sourcesContainer1.classList.add('hidden');
            sourcesList1.innerHTML = '';
            businessCaseButton.disabled = true;
            businessCaseButton.textContent = 'Reviewing...';

            const userQuery = `Here is my draft business case for the surgical ASP initiative. Please review it based on your criteria:
${userText}`;
            
            try {
                const { text, sources } = await makeApiCall(businessCaseSystemPrompt, userQuery);
                if (text) {
                    // Convert Markdown to HTML
                    const html = markdownConverter.makeHtml(text);
                    feedbackOutput1.innerHTML = html;
                    renderSources(sources, sourcesList1, sourcesContainer1);
                } else {
                    handleError('No text response received from the model.', feedbackOutput1);
                }
            } catch (error) {
                console.error(error);
                handleError(`Failed to get feedback. ${error.message}`, feedbackOutput1);
            } finally {
                loadingSpinner1.classList.add('hidden');
                businessCaseButton.disabled = false;
                businessCaseButton.innerHTML = '✨ Submit for Administrator Feedback';
            }
        }

        // === Module 2: Prescriber Profile ===
        const profileButton = document.getElementById('submit-profile');
        const prescriberRole = document.getElementById('prescriber-role');
        const prescriberAttitude = document.getElementById('prescriber-attitude');
        const feedbackOutput2 = document.getElementById('feedback-output-2');
        const loadingSpinner2 = document.getElementById('loading-spinner-2');
        const sourcesContainer2 = document.getElementById('sources-container-2');
        const sourcesList2 = document.getElementById('sources-list-2');
        // NEW: Get reflection elements
        const reflectionContainer2 = document.getElementById('reflection-container-2');
        const fellowReflectionInput = document.getElementById('fellow-reflection');

        profileButton.addEventListener('click', getPrescriberProfile);

        const prescriberProfileSystemPrompt = `Act as an expert in Antimicrobial Stewardship (ASP) and behavioral science. A user (an ID fellow) will provide a prescriber archetype.
Your task is to generate a detailed analysis to help them prepare for an interaction, based on "Tier 2: Behavioral Science & Communication" competencies.

Your response MUST include the following sections, grounded in ASP and behavioral science literature:

### 1. Prescriber Persona
A brief, 1-2 sentence description of this person (e.g., "Dr. Smith is a highly respected surgeon who trusts her clinical experience above all...").

### 2. Likely Psychosocial Drivers
List the likely factors influencing their prescribing (e.g., fear of complications, peer pressure, desire for efficiency, habit).

### 3. Potential Cognitive Biases
Identify 2-3 specific cognitive biases this person might exhibit (e.g., "Commission Bias," "Omission Bias," "Availability Heuristic," "Confirmation Bias"). Briefly explain each bias in one sentence.

### 4. Recommended Communication Strategies
Suggest concrete, evidence-based strategies. Do NOT just say "educate." Use terms from behavioral science.
-   **Example (Good):** "Use **Academic Detailing**: Approach them 1-on-1 with a specific, recent case. Present data comparing their outcomes to their peers."
-   **Example (Good):** "Use **Motivational Interviewing**: Instead of telling them they are wrong, ask open-ended questions like 'What are your biggest concerns about narrowing therapy for this patient?'"
-   **Example (Bad):** "Educate them with a lecture."

Ground your recommendations in real-world evidence.`;

        async function getPrescriberProfile() {
            const role = prescriberRole.value;
            const attitude = prescriberAttitude.value;

            // Show loading state
            loadingSpinner2.classList.remove('hidden');
            feedbackOutput2.innerHTML = '';
            sourcesContainer2.classList.add('hidden');
            sourcesList2.innerHTML = '';
            // NEW: Hide and clear reflection box on new request
            reflectionContainer2.classList.add('hidden');
            fellowReflectionInput.value = '';
            
            profileButton.disabled = true;
            profileButton.textContent = 'Generating...';

            const userQuery = `Generate a prescriber profile and strategy guide for this archetype:
-   **Role:** ${role}
-   **Attitude:** ${attitude}`;
            
            try {
                const { text, sources } = await makeApiCall(prescriberProfileSystemPrompt, userQuery);
                if (text) {
                    // Convert Markdown to HTML
                    const html = markdownConverter.makeHtml(text);
                    feedbackOutput2.innerHTML = html;
                    renderSources(sources, sourcesList2, sourcesContainer2);
                    // NEW: Show reflection box on success
                    reflectionContainer2.classList.remove('hidden');
                } else {
                    handleError('No text response received from the model.', feedbackOutput2);
                }
            } catch (error) {
                console.error(error);
                handleError(`Failed to get feedback. ${error.message}`, feedbackOutput2);
            } finally {
                loadingSpinner2.classList.add('hidden');
                profileButton.disabled = false;
                profileButton.innerHTML = '✨ Generate Prescriber Profile & Strategies';
            }
        }

        // === Common Helper Functions ===

        /**
         * Unified function to call either Gemini or Claude API
         * Implements retry logic with exponential backoff.
         */
        async function makeApiCall(systemPrompt, userMessage, retries = 3, delay = 1000) {
            try {
                // Use literature-enhanced chat endpoint for RAG support
                const payload = {
                    model: currentModel,
                    query: userMessage,  // The main query
                    max_literature: 5    // Get up to 5 relevant papers
                };

                const response = await fetch(`${currentHost}/api/chat/with-literature`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Handle rate limiting (429) and other server errors
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return makeApiCall(systemPrompt, userMessage, retries - 1, delay * 2);
                    }
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Extract text and sources from unified response
                let text = result.response || result.text || '';
                
                // Add sources if available
                if (result.sources && result.sources.length > 0) {
                    text += '\n\n---\n**Sources:**\n';
                    result.sources.forEach((source, idx) => {
                        text += `${idx + 1}. [PMID: ${source.pmid}] ${source.title} (${source.source})\n`;
                    });
                }
                const sources = result.citations || result.sources || [];

                return { text, sources };

            } catch (error) {
                // Handle network errors
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return makeApiCall(systemPrompt, userMessage, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        /**
         * Generic function to call the Gemini API (Legacy - kept for compatibility)
         * Implements retry logic with exponential backoff.
         */
        async function makeGeminiCall(payload, retries = 3, delay = 1000) {
            const apiUrl = API_ENDPOINTS.gemini;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Handle rate limiting (429) and other server errors
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return makeGeminiCall(payload, retries - 1, delay * 2); // Exponential backoff
                    }
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // 1. Extract the generated text
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // 2. Extract grounding sources
                let sources = [];
                const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attr => attr.web)
                        .filter(web => web && web.uri && web.title); // Ensure sources are valid
                }
                
                return { text, sources };

            } catch (error) {
                // Handle network errors
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return makeGeminiCall(payload, retries - 1, delay * 2);
                }
                throw error; // Re-throw error after all retries fail
            }
        }

        /**
         * Renders the list of grounding sources (the "RAG" component)
         */
        function renderSources(sources, listElement, containerElement) {
            if (sources.length === 0) {
                containerElement.classList.add('hidden');
                return;
            }
            
            listElement.innerHTML = ''; // Clear old sources
            sources.forEach(source => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = source.uri;
                a.textContent = source.title;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.className = 'text-indigo-600 hover:text-indigo-800 hover:underline';
                li.appendChild(a);
                listElement.appendChild(li);
            });
            containerElement.classList.remove('hidden');
        }

        /**
         * Displays an error message in the specified feedback box
         */
        function handleError(message, outputElement) {
            outputElement.innerHTML = `<p class="text-red-600 font-medium">${message}</p>`;
        }
    </script>
</body>
</html>




